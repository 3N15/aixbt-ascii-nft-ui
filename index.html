<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AIXBT ASCII NFT Card – Interactive</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
  <style>
    /* … your existing CSS unchanged … */
  </style>
</head>
<body>

  <div class="controls">
    <!-- buttons unchanged … -->
  </div>

  <div class="card" id="card">
    <!-- ASCII card markup unchanged … -->
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    window.onload = () => {
      const asciiEl = document.getElementById('ascii');
      const uploadInput = document.getElementById('uploadInput');
      const cardImage   = document.getElementById('cardImage');

      function getLines() { return asciiEl.textContent.split('\n'); }
      function updateLines(lines) { asciiEl.textContent = lines.join('\n'); }
      function centerLine(text, idx, lines) {
        const w = lines[idx].length - 2;
        const pad = w - text.length;
        const l = Math.floor(pad/2), r = pad - l;
        lines[idx] = '|' + ' '.repeat(l) + text + ' '.repeat(r) + '|';
      }

      // … other handlers unchanged …

      // EDIT TWEET (updated)
      document.getElementById('editTweet').onclick = async () => {
        const urlString = prompt('Enter full tweet URL:');
        if (!urlString) return;

        let tweetId;
        try {
          // 1) Parse URL object – this will drop any query string
          const url = new URL(urlString);
          const segments = url.pathname.split('/').filter(Boolean);
          // 2) Find the "status" segment and take the next one
          const i = segments.indexOf('status');
          if (i === -1 || !segments[i+1]) throw new Error();
          tweetId = segments[i+1];
        } catch {
          alert('Invalid URL – must contain /status/<tweet_id>');
          return;
        }

        // 3) sanity check: must be all digits
        if (!/^\d+$/.test(tweetId)) {
          alert('Invalid tweet ID parsed.');
          return;
        }

        try {
          // 4) Fetch from your proxy
          const resp = await fetch(`/api/tweet?id=${encodeURIComponent(tweetId)}`);
          const json = await resp.json();
          if (!resp.ok || json.error) {
            throw new Error(json.error || `HTTP ${resp.status}`);
          }

          // 5) Update ASCII
          const lines = getLines();
          centerLine(json.data.text.slice(0,37), 12, lines);
          const pm = json.data.public_metrics;
          centerLine(
            `C:${pm.reply_count} R:${pm.retweet_count} L:${pm.like_count} B:${pm.quote_count}`,
            18, lines
          );
          updateLines(lines);
        } catch (err) {
          alert('Error fetching tweet: ' + err.message);
        }
      };

      // DOWNLOAD PNG handler unchanged …
    };
  </script>
</body>
</html>