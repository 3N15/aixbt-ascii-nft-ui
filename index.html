<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AIXBT ASCII NFT Card â€“ Dynamic</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#0a0a0a;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      min-height:100vh; font-family:'Space Mono',monospace; color:#00ffff; padding:20px;
    }
    .controls { margin-bottom:16px; }
    .controls button {
      margin-right:8px; margin-bottom:8px;
      padding:8px 16px; background:#00ffff; color:#0a0a0a;
      border:none; border-radius:4px; cursor:pointer;
      font-family:'Space Mono',monospace;
    }
    .controls button:hover { background:#33ffff; }
    .card {
      width:360px; height:560px; padding:20px;
      background:linear-gradient(145deg,#111,#000);
      border-radius:16px; box-shadow:0 4px 8px rgba(0,255,255,0.2),0 8px 16px rgba(0,255,255,0.1);
      position:relative; overflow:hidden;
    }
    .ascii-img {
      position:absolute; top:106px; left:24px;
      width:312px; height:190px; object-fit:cover; z-index:1;
    }
    .ascii {
      position:absolute; top:20px; left:24px;
      width:312px; white-space:pre; letter-spacing:0;
      font-size:14px; line-height:1.4; z-index:2; color:#00ffff; cursor:text;
    }
    #uploadInput { display:none; }
  </style>
</head>
<body>
  <div class="controls">
    <button id="editTitle">Edit Title</button>
    <button id="editImage">Upload Image</button>
    <button id="editTweet">Edit Tweet</button>
    <button id="downloadBtn">Download PNG</button>
    <input type="file" id="uploadInput" accept="image/*" />
  </div>

  <div class="card" id="card">
    <img id="cardImage" src="placeholder.png" class="ascii-img" alt="content"/>
    <pre id="ascii" class="ascii">
+------------------------------------+
|        INSIDER WALLET DUMP         |
+------------------------------------+

+------------------------------------+
|                                    |
|                                    |
|                                    |
|                                    |
|                                    |
|                                    |
|                                    |
|                                    |
|                                    |
+------------------------------------+
|    #AIXBT-001    |    LEGENDARY    |
+------------------------------------+

+------------------------------------+
|                                    |
|                                    |
|                                    |
|                                    |
|                                    |
+------------------------------------+
| C:0    | R:0    | L:0     | B:0    |
+------------------------------------+</pre>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const asciiEl = document.getElementById('ascii');

    function getLines() {
      return asciiEl.textContent.split('\n');
    }
    function updateLines(lines) {
      asciiEl.textContent = lines.join('\n');
    }
    function centerLine(text, idx, lines) {
      const w = lines[idx].length - 2;
      const pad = w - text.length;
      const l = Math.floor(pad/2), r = pad - l;
      lines[idx] = '|' + ' '.repeat(l) + text + ' '.repeat(r) + '|';
    }

    // Edit Title
    document.getElementById('editTitle').onclick = () => {
      const t = prompt('New title:');
      if (!t) return;
      const lines = getLines();
      centerLine(t, 1, lines);
      updateLines(lines);
    };

    // Upload Image
    document.getElementById('editImage').onclick = () =>
      document.getElementById('uploadInput').click();
    document.getElementById('uploadInput').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => 
        document.getElementById('cardImage').src = reader.result;
      reader.readAsDataURL(file);
    };

    // Edit Tweet
    document.getElementById('editTweet').onclick = async () => {
      const url = prompt('Enter tweet URL:');
      if (!url) return;

      // 1) Extract exactly the numeric ID
      const m = url.match(/status\\/(\\d+)/);
      if (!m) { alert('Invalid URL'); return; }
      const id = m[1];

      // 2) Fetch YOUR proxy
      let resp, json;
      try {
        resp = await fetch(`/api/tweet?id=${encodeURIComponent(id)}`);
        json = await resp.json();
      } catch (err) {
        alert('Network error: ' + err.message);
        return;
      }
      if (!resp.ok || json.error) {
        alert('API error: ' + (json.error||resp.status));
        return;
      }

      // 3) Update lines
      const lines = getLines();
      centerLine(json.data.text.slice(0,37), 12, lines);
      const pm = json.data.public_metrics;
      centerLine(
        \`C:\${pm.reply_count} R:\${pm.retweet_count} L:\${pm.like_count} B:\${pm.quote_count}\`,
        18,
        lines
      );
      updateLines(lines);
    };

    // Download PNG
    document.getElementById('downloadBtn').onclick = () => {
      html2canvas(document.getElementById('card')).then(canvas => {
        const a = document.createElement('a');
        a.download = 'aixbt_ascii_card.png';
        a.href = canvas.toDataURL('image/png');
        a.click();
      });
    };
  </script>
</body>
</html>